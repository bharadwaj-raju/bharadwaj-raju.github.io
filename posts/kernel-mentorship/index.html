<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/icon.png" type="image/png">
  <link rel="stylesheet" href="https://bharadwaj-raju.github.io/style.css?h=fd1cd5b3f23e99f3a0ff">
  <link rel="stylesheet" href="https://bharadwaj-raju.github.io/print.css?h=9191ac8d6abd85d76080"
    media="print">
  <link rel="stylesheet" href="https://bharadwaj-raju.github.io/dark.css?h=54559654853c22f12773"
    media="screen and (prefers-color-scheme: dark)">
  
  <link rel="preload" href="/fonts/alegreya-ht-pro/Alegreya-Regular.woff2" as="font" type="font/woff2"
    crossorigin="anonymous" />
  <link rel="preload" href="/fonts/alegreya-sans-ht/AlegreyaSans-Regular.woff2" as="font" crossorigin="anonymous" />
  <link rel="preload" href="/fonts/alegreya-sans-ht/AlegreyaSansSC-Bold.woff2" as="font" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-dark.css" media="(prefers-color-scheme: dark)" />
  <link rel="stylesheet" type="text/css" href="/syntax-theme-light.css" media="(prefers-color-scheme: light)" />

  <title>Being in the Linux Kernel Mentorship \  ~bharadwaj</title>
</head>

<body>
  <header>
    <nav>
      <a href="/" id="logo"><span id="logo-tilde">~</span><span id="logo-full">bharadwaj</span></a>
      <div id="menu">
        <a href="/posts/">Posts</a>
      </div>
    </nav>
  </header>
  <section class="section">
    <div class="container">
      

<div class="toc">
  <ul>
    
    <li>
      <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#application-acceptance">Application &amp; Acceptance</a>
      
    </li>
    
    <li>
      <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#starting-to-work">Starting to Work</a>
      
    </li>
    
    <li>
      <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#fixes-in-bcachefs">Fixes in bcachefs</a>
      
      <ul>
        
        <li>
          <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#atomic-contexts-and-blocking-functions">Atomic Contexts and Blocking Functions</a>
        </li>
        
        <li>
          <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#error-paths-1">Error Paths, 1</a>
        </li>
        
        <li>
          <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#error-paths-2">Error Paths, 2</a>
        </li>
        
        <li>
          <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#false-positives-from-kmsan">False Positives from KMSAN</a>
        </li>
        
      </ul>
      
    </li>
    
    <li>
      <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#sensor-driver">Sensor Driver</a>
      
    </li>
    
    <li>
      <a href="https://bharadwaj-raju.github.io/posts/kernel-mentorship/#reflections">Reflections</a>
      
    </li>
    
  </ul>
</div>

<main>
  <h1 class="title">
    Being in the Linux Kernel Mentorship
  </h1>
  <p class="dateline subtitle">2025-09-10</p>
  <p>From March to August of this year, I have been a mentee in the Linux Foundation’s <a href="https://wiki.linuxfoundation.org/lkmp">Linux Kernel Mentorship Program</a> alongside my university studies.</p>
<p>I’ve always kind of idolized kernel development, so this was a great opportunity to see what it is really like.</p>
<p>I stumbled upon it quite by accident. <span class="sidenote-ref"><span class="sidenote-ref-text">I was browsing LinkedIn</span><span class="sidenote-number"><small class="sidenote" role="note"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>Not something I usually ever do, really.<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
 looking at alumni from my university, when I saw that one of them, who was working as a kernel engineer at Google, had reposted an announcement for the <abbr>LKMP</abbr>. I clicked through and that was that.</p>
<h2 id="application-acceptance"><a class="zola-anchor" href="#application-acceptance" aria-label="Anchor link for: application-acceptance">Application &amp; Acceptance</a></h2>
<p>I had to create an account on the <abbr>LFX</abbr> Mentorship portal, fill out my profile and a small statement-of-purpose, and then I was given a list of tasks on the basis of which I would be accepted (or not). These tasks ranged from completing <a href="https://training.linuxfoundation.org/training/a-beginners-guide-to-linux-kernel-development-lfc103/">a beginner’s course in kernel development from <abbr>LFX</abbr></a>, to writing a cover letter, to building and experimenting with writing simple kernel modules, and even making patches for small mistakes we could find. I managed to get 5 minor patches into the kernel as part of these preliminary tasks.</p>
<p>I finished my tasks and spent around a week or so awaiting the result. On the 26th of February, I got my acceptance email.</p>
<h2 id="starting-to-work"><a class="zola-anchor" href="#starting-to-work" aria-label="Anchor link for: starting-to-work">Starting to Work</a></h2>
<p>I was invited to a Discord server for the mentees, and each Wednesday we had online meetings with our mentor Shuah Khan, where we covered various useful tools, discussed contribution opportunities, and got non-public (and less harsh) reviews and feedback on our patch attempts.</p>
<p>I decided to focus on fixing bugs, and to that end I tried to fix bugs from <a href="https://syzkaller.appspot.com/">syzkaller</a>. It’s a hosted public dashboard for bugs found via <a href="https://github.com/google/syzkaller/blob/master/docs/syzbot.md">the syz fuzzing system</a>. These are mostly kernel warnings, and reports from <abbr>KASAN</abbr> (Kernel Address Sanitizer), <abbr>KMSAN</abbr> (Memory), and <abbr>UBSAN</abbr> (Undefined Behavior).</p>
<p>This was hard. Not all bugs had working reproducers, or were comprehensible to someone new to the subsystem — to say nothing of the false positives. Most of the viable ones would be solved by an actual kernel engineer faster than I could reproduce and investigate it.</p>
<p>Despite this, I managed to get some bugfixes in bcachefs, from syzkaller. I’ll try to recount the process of investigating and fixing each bug in detail, in the hopes that it might be useful to others looking to fix kernel bugs.</p>
<h2 id="fixes-in-bcachefs"><a class="zola-anchor" href="#fixes-in-bcachefs" aria-label="Anchor link for: fixes-in-bcachefs">Fixes in bcachefs</a></h2>
<p>I picked bcachefs mostly by chance; it happened to have several syzkaller reports when
I looked at the dashboard, and they seemed approachable.</p>
<h3 id="atomic-contexts-and-blocking-functions"><a class="zola-anchor" href="#atomic-contexts-and-blocking-functions" aria-label="Anchor link for: atomic-contexts-and-blocking-functions">Atomic Contexts and Blocking Functions</a></h3>
<p>I started by picking this syzkaller bug: <a href="https://syzkaller.appspot.com/bug?extid=c82cd2906e2f192410bb">BUG: sleeping function called from invalid context in <code>bch2_printbuf_make_room</code>
(2)</a>.</p>
<p>Let’s look at (the relevant parts of) the crash report.</p>
<pre data-lang="crash" class="language-crash z-code"><code class="language-crash" data-lang="crash"><span class="z-text z-plain">BUG: sleeping function called from invalid context at ./include/linux/sched/mm.h:321
in_atomic(): 0, irqs_disabled(): 0, non_block: 0, pid: 5828, name: syz-executor246
preempt_count: 0, expected: 0
RCU nest depth: 1, expected: 0
3 locks held by syz-executor246/5828:
 #0: ffff88807ad6a0e0 (&amp;type-&gt;s_umount_key#42/1){+.+.}-{4:4}, at: alloc_super+0x221/0x9d0 fs/super.c:344
 #1: ffff888075a84210 (&amp;c-&gt;btree_trans_barrier){.+.+}-{0:0}, at: srcu_lock_acquire include/linux/srcu.h:161 [inline]
 #1: ffff888075a84210 (&amp;c-&gt;btree_trans_barrier){.+.+}-{0:0}, at: srcu_read_lock include/linux/srcu.h:253 [inline]
 #1: ffff888075a84210 (&amp;c-&gt;btree_trans_barrier){.+.+}-{0:0}, at: __bch2_trans_get+0x7ed/0xd40 fs/bcachefs/btree_iter.c:3386
 #2: ffffffff8ed3b560 (rcu_read_lock){....}-{1:3}, at: rcu_lock_acquire include/linux/rcupdate.h:331 [inline]
 #2: ffffffff8ed3b560 (rcu_read_lock){....}-{1:3}, at: rcu_read_lock include/linux/rcupdate.h:841 [inline]
 #2: ffffffff8ed3b560 (rcu_read_lock){....}-{1:3}, at: bch2_bkey_pick_read_device+0x29c/0x19b0 fs/bcachefs/extents.c:144
CPU: 0 UID: 0 PID: 5828 Comm: syz-executor246 Not tainted 6.14.0-syzkaller-11270-g08733088b566 #0 PREEMPT(full) 
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 02/12/2025
Call Trace:
 &lt;TASK&gt;
 __dump_stack lib/dump_stack.c:94 [inline]
 dump_stack_lvl+0x241/0x360 lib/dump_stack.c:120
 __might_resched+0x558/0x6c0 kernel/sched/core.c:8818
 might_alloc include/linux/sched/mm.h:321 [inline]
 slab_pre_alloc_hook mm/slub.c:4089 [inline]
 slab_alloc_node mm/slub.c:4167 [inline]
 __do_kmalloc_node mm/slub.c:4317 [inline]
 __kmalloc_node_track_caller_noprof+0xd3/0x4d0 mm/slub.c:4337
 __do_krealloc mm/slub.c:4895 [inline]
 krealloc_noprof+0x10f/0x300 mm/slub.c:4948
 bch2_printbuf_make_room+0x1f1/0x350 fs/bcachefs/printbuf.c:59
 bch2_prt_printf+0x269/0x6d0 fs/bcachefs/printbuf.c:186
 bch2_log_msg_start fs/bcachefs/error.c:19 [inline]
 bch2_fs_trans_inconsistent fs/bcachefs/error.c:63 [inline]
 bch2_fs_inconsistent+0x143/0x220 fs/bcachefs/error.c:81
 bch2_dev_rcu fs/bcachefs/sb-members.h:226 [inline]
 bch2_bkey_pick_read_device+0x95e/0x19b0 fs/bcachefs/extents.c:165
 bch2_btree_node_read+0x7ac/0x29e0 fs/bcachefs/btree_io.c:1706
 __bch2_btree_root_read fs/bcachefs/btree_io.c:1796 [inline]
 bch2_btree_root_read+0x656/0x7e0 fs/bcachefs/btree_io.c:1818
 read_btree_roots+0x3d7/0xa80 fs/bcachefs/recovery.c:581
 bch2_fs_recovery+0x28e4/0x3e20 fs/bcachefs/recovery.c:928
 bch2_fs_start+0x2fb/0x610 fs/bcachefs/super.c:1060
 bch2_fs_get_tree+0x113e/0x18f0 fs/bcachefs/fs.c:2253
 vfs_get_tree+0x90/0x2b0 fs/super.c:1759
 do_new_mount+0x2cf/0xb70 fs/namespace.c:3878
 do_mount fs/namespace.c:4218 [inline]
 __do_sys_mount fs/namespace.c:4429 [inline]
 __se_sys_mount+0x38c/0x400 fs/namespace.c:4406
 do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]
 do_syscall_64+0xf3/0x230 arch/x86/entry/syscall_64.c:94
 entry_SYSCALL_64_after_hwframe+0x77/0x7f
</span></code></pre>
<p>Now, where do we look for the bug? The first thing to look for is the last bcachefs function in the call trace, because it is a reasonable assumption that the bug is in bcachefs code and not in core kernel memory management code. That is <code>bch2_printbuf_make_room</code>.</p>
<p>Right, but what is an “invalid context” anyway? <span class="sidenote-ref"><span class="sidenote-ref-text">Researching the error message</span><span class="sidenote-number"><small class="sidenote" role="note"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://stackoverflow.com/questions/16538824/bug-sleeping-function-called-from-invalid-context-at-mm-slub-c1719">Even good old StackOverflow suffices.</a><span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
 will tell us that “invalid” here is “atomic”. You can’t call a function which may sleep from an atomic context.</p>
<p>Although we don’t need this to solve the bug, we might as well ask ourselves why we’re in an atomic context here. The reason can be seen in the <code>locks held</code> part of the report, which lists an <code>rcu_read_lock</code> held by <code>bch2_bkey_pick_read_device</code>. <span class="sidenote-ref"><span class="sidenote-ref-text">It is illegal to block while in an <abbr>RCU</abbr> read-side critical section.</span><span class="sidenote-number"><small class="sidenote" role="note"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://www.kernel.org/doc/html/next/RCU/whatisRCU.html#rcu-read-lock">https://www.kernel.org/doc/html/next/RCU/whatisRCU.html#rcu-read-lock</a><span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
</p>
<p>What are the offending functions? Let’s look at what <code>bch2_printbuf_make_room</code> is doing, exactly.</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/printbuf.c?id=08733088b566b58283f0f12fb73f5db6a9a9de30#n59"><code>fs/bcachefs/printbuf.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">bch2_printbuf_make_room</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> printbuf <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">out</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">unsigned</span> <span class="z-variable z-parameter z-c">extra</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	…
  
	<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span>
	 <span class="z-punctuation z-definition z-comment z-c">*</span> Note: output buffer must be freeable with kfree(), it&#39;s not required
	 <span class="z-punctuation z-definition z-comment z-c">*</span> that the user use printbuf_exit().
	 <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<mark>	<span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span>buf <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">krealloc</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">out<span class="z-punctuation z-accessor z-c">-&gt;</span>buf<span class="z-punctuation z-separator z-c">,</span> new_size<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-arithmetic z-c">!</span>out<span class="z-punctuation z-accessor z-c">-&gt;</span>atomic <span class="z-keyword z-operator z-ternary z-c">?</span> GFP_KERNEL <span class="z-keyword z-operator z-ternary z-c">:</span> GFP_NOWAIT</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>
	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>buf<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
		out<span class="z-punctuation z-accessor z-c">-&gt;</span>allocation_failure <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c">;</span>
		out<span class="z-punctuation z-accessor z-c">-&gt;</span>overflow <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>ENOMEM<span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>

	out<span class="z-punctuation z-accessor z-c">-&gt;</span>buf	<span class="z-keyword z-operator z-assignment z-c">=</span> buf<span class="z-punctuation z-terminator z-c">;</span>
	out<span class="z-punctuation z-accessor z-c">-&gt;</span>size	<span class="z-keyword z-operator z-assignment z-c">=</span> new_size<span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>That <code>krealloc</code> call is what the crash report is complaining about as well. It’s interesting that the call does seem to think about atomicity, from the <code>!out-&gt;atomic ? GFP_KERNEL : GFP_NOWAIT</code>. Then, <code>out-&gt;atomic</code> must not be correctly maintained? Let’s step back in the call trace and look at how the caller is using this <code>struct printbuf</code>.</p>
<p>First we would look at <code>bch2_prt_printf</code>, but that’s not where the <code>struct printbuf</code> is constructed. Neither is it one more step back, in <code>bch2_log_msg_start</code>. Finally we see it being constructed in <code>bch2_fs_trans_inconsistent</code>:</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/error.c?id=08733088b566b58283f0f12fb73f5db6a9a9de30#n61"><code>fs/bcachefs/error.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">3</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
<span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">bool</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">bch2_fs_trans_inconsistent</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> btree_trans <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">trans</span><span class="z-punctuation z-separator z-c">,</span>
				       <span class="z-storage z-modifier z-c">const</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">fmt</span><span class="z-punctuation z-separator z-c">,</span> va_list <span class="z-variable z-parameter z-c">args</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
<mark>	<span class="z-storage z-type z-c">struct</span> printbuf buf <span class="z-keyword z-operator z-assignment z-c">=</span> PRINTBUF<span class="z-punctuation z-terminator z-c">;</span>
</mark>
	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_log_msg_start</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prt_vprintf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>buf<span class="z-punctuation z-separator z-c">,</span> fmt<span class="z-punctuation z-separator z-c">,</span> args</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prt_newline</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>trans<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_trans_updates_to_text</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>buf<span class="z-punctuation z-separator z-c">,</span> trans</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-storage z-type z-c">bool</span> ret <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__bch2_inconsistent_error</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_print_string_as_lines</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">KERN_ERR<span class="z-punctuation z-separator z-c">,</span> buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">buf</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">printbuf_exit</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-keyword z-control z-flow z-return z-c">return</span> ret<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>and expanding the <code>PRINTBUF</code> macro…</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/printbuf.h?id=08733088b566b58283f0f12fb73f5db6a9a9de30#n133"><code>fs/bcachefs/printbuf.h</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Initializer for a heap allocated printbuf: <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PRINTBUF</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">struct</span> printbuf<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span> <span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">heap_allocated</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-language z-c">true</span> <span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
</span></code></pre>
<p>So <code>buf.atomic</code> is <code>0</code>. Hence the <code>krealloc</code> call is made with <code>GFP_KERNEL</code>, which is potentially blocking. How do we correctly handle this <code>.atomic</code> field? Let’s look for examples in <code>fs/bcachefs</code>.</p>
<pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c">❯ rg <span class="z-keyword z-operator z-arithmetic z-c">-</span>F <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&#39;</span>.atomic<span class="z-punctuation z-definition z-string z-end z-c">&#39;</span></span>
journal<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">145</span><span class="z-keyword z-operator z-ternary z-c">:</span>    buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">273</span><span class="z-keyword z-operator z-ternary z-c">:</span>            pbuf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">287</span><span class="z-keyword z-operator z-ternary z-c">:</span>            err<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>

btree_io<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">2246</span><span class="z-keyword z-operator z-ternary z-c">:</span>           buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>

error<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">46</span><span class="z-keyword z-operator z-ternary z-c">:</span>     buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">62</span><span class="z-keyword z-operator z-ternary z-c">:</span>     buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>

debug<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">515</span><span class="z-keyword z-operator z-ternary z-c">:</span>            i<span class="z-punctuation z-accessor z-c">-&gt;</span>buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">531</span><span class="z-keyword z-operator z-ternary z-c">:</span>            <span class="z-keyword z-operator z-arithmetic z-c">--</span>i<span class="z-punctuation z-accessor z-c">-&gt;</span>buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-punctuation z-terminator z-c">;</span>

journal_reclaim<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">225</span><span class="z-keyword z-operator z-ternary z-c">:</span>                    buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>

alloc_foreground<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">1638</span><span class="z-keyword z-operator z-ternary z-c">:</span>   buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">1647</span><span class="z-keyword z-operator z-ternary z-c">:</span>   <span class="z-keyword z-operator z-arithmetic z-c">--</span>buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-punctuation z-terminator z-c">;</span>

btree_locking<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">c</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">164</span><span class="z-keyword z-operator z-ternary z-c">:</span>            buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
<span class="z-constant z-numeric z-integer z-decimal z-c">200</span><span class="z-keyword z-operator z-ternary z-c">:</span>    buf<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">atomic</span><span class="z-keyword z-operator z-arithmetic z-c">++</span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre>
<p>Alright. So we’re supposed to increment the <code>.atomic</code> field before working with the buffer, and decrement it when done. Let’s do that. It should be fixed now, right?</p>
<p>Nope, we get a similar crash. What gives? Turns out there’s one more blocking function left in this codepath. It’s <code>bch2_print_string_as_lines</code>, due to it calling <code>console_lock</code>. Luckily for us, there is a direct replacement function already there, called… <code>bch2_print_string_as_lines_nonblocking</code>. We just replace the call, and we’re finally done.</p>
<p><small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span>Kent Overstreet is really nice, by the way. He even suggested possible further work in that thread for me. Namely, trying to replace <code>print_string_as_lines</code> entirely by calling something lower-level which didn’t have the 1k chars limitation of <code>printk</code>. Unfortunately I did not find a straightforward lower function to <code>printk</code> that would’ve done what we wanted, but still.<span class="sidenote-surroundings">)&nbsp;</span></small>
Now, having done this, I submitted <a href="https://lore.kernel.org/all/20250402161043.161795-1-bharadwaj.raju777@gmail.com/T/">my patch</a> to the bcachefs mailing list, only to be told by Kent Overstreet that he had beat me to it. But! He hadn’t replaced the <code>bch2_print_string_as_lines</code> call, which meant the issue wasn’t fully fixed, and I still had a contribution to make. I made <a href="https://lore.kernel.org/linux-bcachefs/20250402181556.81529-1-bharadwaj.raju777@gmail.com/T/">another patch</a> doing only that, and it was accepted.</p>
<h3 id="error-paths-1"><a class="zola-anchor" href="#error-paths-1" aria-label="Anchor link for: error-paths-1">Error Paths, 1</a></h3>
<p>The bug this time is <a href="https://syzkaller.appspot.com/bug?extid=cfd994b9cdf00446fd54"><abbr>UBSAN</abbr>: shift-out-of-bounds in <code>__bch2_bkey_unpack_key</code></a>.</p>
<p>Crash report:</p>
<pre data-lang="crash" class="language-crash z-code"><code class="language-crash" data-lang="crash"><span class="z-text z-plain">UBSAN: shift-out-of-bounds in fs/bcachefs/bkey.c:163:16
shift exponent 4294967127 is too large for 64-bit type &#39;u64&#39; (aka &#39;unsigned long long&#39;)
CPU: 0 UID: 0 PID: 5832 Comm: read_btree_node Not tainted 6.15.0-syzkaller-01958-g785cdec46e92 #0 PREEMPT(full) 
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 05/07/2025
Call Trace:
 &lt;TASK&gt;
 dump_stack_lvl+0x189/0x250 lib/dump_stack.c:120
 ubsan_epilogue+0xa/0x40 lib/ubsan.c:231
 __ubsan_handle_shift_out_of_bounds+0x386/0x410 lib/ubsan.c:492
 get_inc_field fs/bcachefs/bkey.c:163 [inline]
 __bch2_bkey_unpack_key+0xdc4/0xe10 fs/bcachefs/bkey.c:284
 __bch2_bkey_compat+0x4db/0xbd0 fs/bcachefs/bkey_methods.c:480
 bch2_bkey_compat fs/bcachefs/bkey_methods.h:134 [inline]
 validate_bset_keys+0x6c1/0x1390 fs/bcachefs/btree_io.c:983
 bch2_btree_node_read_done+0x18c8/0x4f60 fs/bcachefs/btree_io.c:1211
 btree_node_read_work+0x426/0xe30 fs/bcachefs/btree_io.c:1400
 bch2_btree_node_read+0x887/0x29f0 fs/bcachefs/btree_io.c:-1
 bch2_btree_node_fill+0xd12/0x14f0 fs/bcachefs/btree_cache.c:994
 bch2_btree_node_get_noiter+0xa2c/0x1000 fs/bcachefs/btree_cache.c:1261
 found_btree_node_is_readable fs/bcachefs/btree_node_scan.c:85 [inline]
 try_read_btree_node fs/bcachefs/btree_node_scan.c:220 [inline]
 read_btree_nodes_worker+0x1319/0x1e20 fs/bcachefs/btree_node_scan.c:269
 kthread+0x711/0x8a0 kernel/kthread.c:464
 ret_from_fork+0x4e/0x80 arch/x86/kernel/process.c:148
 ret_from_fork_asm+0x1a/0x30 arch/x86/entry/entry_64.S:245
 &lt;/TASK&gt;
---[ end trace ]---
</span></code></pre>
<p>That shift exponent does look too large. Let’s check out the function where it happens.</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/bkey.c?id=785cdec46e9227f9433884ed3b436471e944007c#n163"><code>fs/bcachefs/bkey.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c">__always_inline
<span class="z-storage z-modifier z-c">static</span> u64 <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">get_inc_field</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> unpack_state <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">state</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">unsigned</span> <span class="z-variable z-parameter z-c">field</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">unsigned</span> bits <span class="z-keyword z-operator z-assignment z-c">=</span> state<span class="z-punctuation z-accessor z-c">-&gt;</span>format<span class="z-punctuation z-accessor z-c">-&gt;</span>bits_per_field<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>field<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>
	u64 v <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> offset <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">le64_to_cpu</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">state<span class="z-punctuation z-accessor z-c">-&gt;</span>format<span class="z-punctuation z-accessor z-c">-&gt;</span>field_offset<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>field<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>bits <span class="z-keyword z-operator z-comparison z-c">&gt;=</span> state<span class="z-punctuation z-accessor z-c">-&gt;</span>bits<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
<mark>		v <span class="z-keyword z-operator z-assignment z-c">=</span> state<span class="z-punctuation z-accessor z-c">-&gt;</span>w <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-constant z-numeric z-integer z-decimal z-c">64</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span> bits<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>		bits <span class="z-keyword z-operator z-assignment z-augmented z-c">-=</span> state<span class="z-punctuation z-accessor z-c">-&gt;</span>bits<span class="z-punctuation z-terminator z-c">;</span>

		state<span class="z-punctuation z-accessor z-c">-&gt;</span>p <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">next_word</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">state<span class="z-punctuation z-accessor z-c">-&gt;</span>p</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		state<span class="z-punctuation z-accessor z-c">-&gt;</span>w <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-c">*</span>state<span class="z-punctuation z-accessor z-c">-&gt;</span>p<span class="z-punctuation z-terminator z-c">;</span>
		state<span class="z-punctuation z-accessor z-c">-&gt;</span>bits <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">64</span><span class="z-punctuation z-terminator z-c">;</span>
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>

	<span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> avoid shift by 64 if bits is 0 - bits is never 64 here: <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
	v <span class="z-keyword z-operator z-assignment z-augmented z-c">|=</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>state<span class="z-punctuation z-accessor z-c">-&gt;</span>w <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&gt;&gt;</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-constant z-numeric z-integer z-decimal z-c">63</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span> bits<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
	state<span class="z-punctuation z-accessor z-c">-&gt;</span>w <span class="z-keyword z-operator z-assignment z-augmented z-c">&lt;&lt;=</span> bits<span class="z-punctuation z-terminator z-c">;</span>
	state<span class="z-punctuation z-accessor z-c">-&gt;</span>bits <span class="z-keyword z-operator z-assignment z-augmented z-c">-=</span> bits<span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-keyword z-control z-flow z-return z-c">return</span> v <span class="z-keyword z-operator z-arithmetic z-c">+</span> offset<span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p><code>(64 - bits)</code> became <code>4294967127</code>. Shift exponents are unsigned, so <code>bits</code> must have been greater than 64 to cause a huge value when cast. We can calculate (or <code>printk</code>) to see that <code>bits == 233</code>.</p>
<p>So <code>state-&gt;format</code> has invalid values. Where does it come from? If we follow it up the call stack, we see that it comes from <code>struct btree</code> itself and is passed here:</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/btree_io.c?id=785cdec46e9227f9433884ed3b436471e944007c#n983"><code>fs/bcachefs/btree_io.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">validate_bset_keys</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> btree <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">b</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">struct</span> bset <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">i</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">write</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">struct</span> bch_io_failures <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">failed</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">struct</span> printbuf <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">err_msg</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">

		…

		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>write<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
			<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_bkey_compat</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">b<span class="z-punctuation z-accessor z-c">-&gt;</span>c<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">level</span><span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-accessor z-c">-&gt;</span>c<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">btree_id</span><span class="z-punctuation z-separator z-c">,</span> version<span class="z-punctuation z-separator z-c">,</span>
				    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">BSET_BIG_ENDIAN</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">i</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-separator z-c">,</span> write<span class="z-punctuation z-separator z-c">,</span>
<mark>				    <span class="z-keyword z-operator z-c">&amp;</span>b<span class="z-punctuation z-accessor z-c">-&gt;</span>format<span class="z-punctuation z-separator z-c">,</span> k</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>
		…

</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>Well… what now? Let’s look at where <code>validate_bset_keys</code> is being called from here.</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/btree_io.c?id=785cdec46e9227f9433884ed3b436471e944007c#n1211"><code>fs/bcachefs/btree_io.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">bch2_btree_node_read_done</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> bch_dev <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">ca</span><span class="z-punctuation z-separator z-c">,</span>
			      <span class="z-storage z-type z-c">struct</span> btree <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">b</span><span class="z-punctuation z-separator z-c">,</span>
			      <span class="z-storage z-type z-c">struct</span> bch_io_failures <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">failed</span><span class="z-punctuation z-separator z-c">,</span>
			      <span class="z-storage z-type z-c">struct</span> printbuf <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">err_msg</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
		…
    
		ret <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">validate_bset</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> ca<span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-separator z-c">,</span> i<span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-accessor z-c">-&gt;</span>written<span class="z-punctuation z-separator z-c">,</span> sectors<span class="z-punctuation z-separator z-c">,</span> READ<span class="z-punctuation z-separator z-c">,</span> failed<span class="z-punctuation z-separator z-c">,</span> err_msg</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>ret<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
			<span class="z-keyword z-control z-flow z-goto z-c">goto</span> fsck_err<span class="z-punctuation z-terminator z-c">;</span>

		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>b<span class="z-punctuation z-accessor z-c">-&gt;</span>written<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
			<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">btree_node_set_format</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">b<span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-accessor z-c">-&gt;</span>data<span class="z-punctuation z-accessor z-c">-&gt;</span>format</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

<mark>		ret <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">validate_bset_keys</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-separator z-c">,</span> i<span class="z-punctuation z-separator z-c">,</span> READ<span class="z-punctuation z-separator z-c">,</span> failed<span class="z-punctuation z-separator z-c">,</span> err_msg</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</mark>		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>ret<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
			<span class="z-keyword z-control z-flow z-goto z-c">goto</span> fsck_err<span class="z-punctuation z-terminator z-c">;</span>

		…
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>There’s a lot of validation functions in the surrounding code, which is interesting. If <code>validate_bset_keys</code> fails on an invalid format, then maybe it expects a previous validation step to have caught it? There’s some reference to <code>btree_node_set_format</code> immediately after <code>validate_bset</code>, so let’s see if there’s anything relevant to us there. Turns out there isn’t any validation in <code>btree_node_set_format</code> itself, so maybe it’s happening before. Let’s read <code>validate_bset</code> instead. It’s a huge function, nevertheless a careful reading rewards us:</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/btree_io.c?id=785cdec46e9227f9433884ed3b436471e944007c#n861"><code>fs/bcachefs/btree_io.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">validate_bset</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> bch_dev <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">ca</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">struct</span> btree <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">b</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> bset <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">i</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">unsigned</span> <span class="z-variable z-parameter z-c">offset</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">unsigned</span> <span class="z-variable z-parameter z-c">sectors</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">write</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">struct</span> bch_io_failures <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">failed</span><span class="z-punctuation z-separator z-c">,</span>
			 <span class="z-storage z-type z-c">struct</span> printbuf <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">err_msg</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
		…

<mark>		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">btree_err_on</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_bkey_format_invalid</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>bn<span class="z-punctuation z-accessor z-c">-&gt;</span>format<span class="z-punctuation z-separator z-c">,</span> write<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>buf1</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-separator z-c">,</span>
</mark>			     <span class="z-keyword z-operator z-arithmetic z-c">-</span>BCH_ERR_btree_node_read_err_bad_node<span class="z-punctuation z-separator z-c">,</span>
			     c<span class="z-punctuation z-separator z-c">,</span> ca<span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-separator z-c">,</span> i<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c">,</span>
			     btree_node_bad_format<span class="z-punctuation z-separator z-c">,</span>
			     <span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>invalid bkey format: <span class="z-constant z-other z-placeholder z-c">%s</span><span class="z-constant z-character z-escape z-c">\n</span><span class="z-constant z-other z-placeholder z-c">%s</span><span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span> buf1<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">buf</span><span class="z-punctuation z-separator z-c">,</span>
			     <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">printbuf_reset</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>buf2</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-separator z-c">,</span>
			      <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_bkey_format_to_text</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-c">&amp;</span>buf2<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&amp;</span>bn<span class="z-punctuation z-accessor z-c">-&gt;</span>format</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-separator z-c">,</span> buf2<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">buf</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

		…
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>So there is a function to validate the format after all! So, the question becomes: why did it not catch the invalid format? Adding a <code>printk</code> to log its result tells us that it <em>does</em> return <code>-BCH_ERR_invalid</code>. What gives?</p>
<p>The answer is in <code>btree_err_on</code>, and how it deals with <code>btree_node_bad_format</code> errors.</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/btree_io.c?id=785cdec46e9227f9433884ed3b436471e944007c#n656"><code>fs/bcachefs/btree_io.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">btree_err</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">type</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">ca</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">b</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">i</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">k</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">_err_type</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">msg</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c">		<span class="z-punctuation z-separator z-continuation z-c">\</span>
<span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>									\
	<span class="z-storage z-type z-c">int</span> _ret <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__btree_err</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">type<span class="z-punctuation z-separator z-c">,</span> c<span class="z-punctuation z-separator z-c">,</span> ca<span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-separator z-c">,</span> i<span class="z-punctuation z-separator z-c">,</span> k<span class="z-punctuation z-separator z-c">,</span> write<span class="z-punctuation z-separator z-c">,</span>		\
			       BCH_FSCK_ERR_##_err_type<span class="z-punctuation z-separator z-c">,</span>		\
			       failed<span class="z-punctuation z-separator z-c">,</span> err_msg<span class="z-punctuation z-separator z-c">,</span>				\
			       msg<span class="z-punctuation z-separator z-c">,</span> ##__VA_ARGS__</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>			\
									\
<mark>	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>_ret <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>BCH_ERR_fsck_fix<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>				\
</mark>		ret <span class="z-keyword z-operator z-assignment z-c">=</span> _ret<span class="z-punctuation z-terminator z-c">;</span>						\
		<span class="z-keyword z-control z-flow z-goto z-c">goto</span> fsck_err<span class="z-punctuation z-terminator z-c">;</span>						\
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>								\
									\
	<span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c">;</span>								\
<span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>

<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">btree_err_on</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">cond</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c">	<span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>cond<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-ternary z-c">?</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">btree_err</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">__VA_ARGS__</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
</span></code></pre>
<p>So, the jump to <code>fsck_err</code> is only made if the return value from <code>__btree_err</code> is not <code>-BCH_ERR_fsck_fix</code>. Let’s look at what <code>__btree_err</code> does, then.</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/btree_io.c?id=785cdec46e9227f9433884ed3b436471e944007c#n546"><code>fs/bcachefs/btree_io.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__printf</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">11</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">12</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>
<span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">__btree_err</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">ret</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> bch_dev <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">ca</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> btree <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">b</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> bset <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">i</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> bkey_packed <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">k</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">rw</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">enum</span> bch_sb_error_id <span class="z-variable z-parameter z-c">err_type</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> bch_io_failures <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">failed</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-type z-c">struct</span> printbuf <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">err_msg</span><span class="z-punctuation z-separator z-c">,</span>
		       <span class="z-storage z-modifier z-c">const</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">fmt</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
<mark>	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>c<span class="z-punctuation z-accessor z-c">-&gt;</span>recovery<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">curr_pass</span> <span class="z-keyword z-operator z-comparison z-c">==</span> BCH_RECOVERY_PASS_scan_for_btree_nodes<span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</mark><mark>		<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>BCH_ERR_fsck_fix<span class="z-punctuation z-terminator z-c">;</span>
</mark>
	…
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p>And that’s it (confirmed by a bit of logging). If the current recovery pass is “scan for btree nodes”, then all kinds of errors will be turned into <code>-BCH_ERR_fsck_fix</code>.</p>
<p>This offending line was added in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=cd3cdb1ef706a1ac725194d81858d58375739b25"><code>cd3cdb1ef706</code></a>. Previously it would have returned <code>__bch2_topology_error(c, &amp;out)</code>.</p>
<p>Based on that I made my <a href="https://lore.kernel.org/all/20250614185743.657564-1-bharadwaj.raju777@gmail.com/T/">first patch</a>, but based on feedback I sent a simpler <a href="https://lore.kernel.org/all/20250615164547.11900-1-bharadwaj.raju777@gmail.com/T/">second patch</a>, which was accepted. The function now checks if it is <code>-BCH_ERR_btree_node_read_err_fixable</code> before returning <code>fsck_fix</code>.</p>
<h3 id="error-paths-2"><a class="zola-anchor" href="#error-paths-2" aria-label="Anchor link for: error-paths-2">Error Paths, 2</a></h3>
<p>The bug at hand: <a href="https://syzkaller.appspot.com/bug?extid=029d1989099aa5ae3e89"><abbr>UBSAN</abbr>: shift-out-of-bounds in <code>__bch2_btree_node_hash_insert</code></a>.</p>
<pre data-lang="crash" class="language-crash z-code"><code class="language-crash" data-lang="crash"><span class="z-text z-plain">  node offset 0/16 bset u64s 0: incorrect max key U64_MAX:18374686479671623680:50331647, btree topology error: 
bcachefs (loop0): flagging btree xattrs lost data
bcachefs (loop0): running explicit recovery pass check_backpointers_to_extents (16), currently at recovery_pass_empty (0)
bcachefs (loop0): running explicit recovery pass scan_for_btree_nodes (1), currently at recovery_pass_empty (0)
bcachefs (loop0): error reading btree root btree=xattrs level=0: btree_node_read_error, fixing
------------[ cut here ]------------
UBSAN: shift-out-of-bounds in fs/bcachefs/btree_cache.c:218:18
shift exponent 251 is too large for 64-bit type &#39;unsigned long long&#39;
CPU: 0 UID: 0 PID: 5830 Comm: syz-executor323 Not tainted 6.15.0-rc1-syzkaller-00246-g900241a5cc15 #0 PREEMPT(full) 
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 02/12/2025
Call Trace:
 &lt;TASK&gt;
 __dump_stack lib/dump_stack.c:94 [inline]
 dump_stack_lvl+0x241/0x360 lib/dump_stack.c:120
 ubsan_epilogue lib/ubsan.c:231 [inline]
 __ubsan_handle_shift_out_of_bounds+0x3c8/0x420 lib/ubsan.c:492
 __btree_node_pinned fs/bcachefs/btree_cache.c:218 [inline]
 __bch2_btree_node_hash_insert+0x1b32/0x1ba0 fs/bcachefs/btree_cache.c:294
 bch2_btree_node_hash_insert+0x7e/0xc0 fs/bcachefs/btree_cache.c:309
 __bch2_btree_root_read fs/bcachefs/btree_io.c:1791 [inline]
 bch2_btree_root_read+0x605/0x7e0 fs/bcachefs/btree_io.c:1819
 read_btree_roots+0x3d7/0xa80 fs/bcachefs/recovery.c:581
 bch2_fs_recovery+0x28e4/0x3e20 fs/bcachefs/recovery.c:928
 bch2_fs_start+0x310/0x620 fs/bcachefs/super.c:1059
 bch2_fs_get_tree+0x113e/0x18f0 fs/bcachefs/fs.c:2253
 vfs_get_tree+0x90/0x2b0 fs/super.c:1759
 do_new_mount+0x2cf/0xb70 fs/namespace.c:3879
 do_mount fs/namespace.c:4219 [inline]
 __do_sys_mount fs/namespace.c:4430 [inline]
 __se_sys_mount+0x38c/0x400 fs/namespace.c:4407
 do_syscall_x64 arch/x86/entry/syscall_64.c:63 [inline]
 do_syscall_64+0xf3/0x230 arch/x86/entry/syscall_64.c:94
 entry_SYSCALL_64_after_hwframe+0x77/0x7f
RIP: 0033:0x7f3aa1b3afaa
Code: d8 64 89 02 48 c7 c0 ff ff ff ff eb a6 e8 5e 04 00 00 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 49 89 ca b8 a5 00 00 00 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b8 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007ffe042c3768 EFLAGS: 00000282 ORIG_RAX: 00000000000000a5
RAX: ffffffffffffffda RBX: 00007ffe042c3780 RCX: 00007f3aa1b3afaa
RDX: 0000200000000180 RSI: 0000200000000540 RDI: 00007ffe042c3780
RBP: 0000200000000540 R08: 00007ffe042c37c0 R09: 0000000000005964
R10: 0000000000800000 R11: 0000000000000282 R12: 0000200000000180
R13: 00007ffe042c37c0 R14: 0000000000000003 R15: 0000000000800000
 &lt;/TASK&gt;
---[ end trace ]---
</span></code></pre>
<p>Let’s look at the last function to see what exactly is invalid.</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/btree_cache.c?id=900241a5cc15e6e0709a012051cc72d224cd6a6e#n218"><code>fs/bcachefs/btree_cache.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-modifier z-c">inline</span> <span class="z-storage z-type z-c">bool</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">__btree_node_pinned</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> btree_cache <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">bc</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> btree <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">b</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">struct</span> bbpos pos <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">BBPOS</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">b<span class="z-punctuation z-accessor z-c">-&gt;</span>c<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">btree_id</span><span class="z-punctuation z-separator z-c">,</span> b<span class="z-punctuation z-accessor z-c">-&gt;</span>key<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">k</span><span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">p</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>

	u64 mask <span class="z-keyword z-operator z-assignment z-c">=</span> bc<span class="z-punctuation z-accessor z-c">-&gt;</span>pinned_nodes_mask<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-keyword z-operator z-arithmetic z-c">!</span><span class="z-keyword z-operator z-arithmetic z-c">!</span>b<span class="z-punctuation z-accessor z-c">-&gt;</span>c<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">level</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-terminator z-c">;</span>

<mark>	<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>mask <span class="z-keyword z-operator z-c">&amp;</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">BIT_ULL</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">b<span class="z-punctuation z-accessor z-c">-&gt;</span>c<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">btree_id</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span>
</mark>		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bbpos_cmp</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">bc<span class="z-punctuation z-accessor z-c">-&gt;</span>pinned_nodes_start<span class="z-punctuation z-separator z-c">,</span> pos</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span> <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span>
		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bbpos_cmp</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">bc<span class="z-punctuation z-accessor z-c">-&gt;</span>pinned_nodes_end<span class="z-punctuation z-separator z-c">,</span> pos</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">&gt;=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre>
<p><code>BIT_ULL(nr)</code> expands to <code>1ULL &lt;&lt; nr</code>. So <code>b-&gt;c.btree_id</code> is too large at 251.</p>
<p>But… what are the valid values for <code>btree_id</code>? Where does it come from, and where is it validated, if anywhere?</p>
<p>There are many ways you could try to research these questions. What I did was just search for <code>btree_id</code> in the codebase and scan through for interesting instances.<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span>With some more forethought, you could save time by assuming that a validation check, if it existed, would probably be in the form of <code>btree_id\s+(&gt;|&lt;)</code> and search for that.<span class="sidenote-surroundings">)&nbsp;</span></small></p>
<p>I found this:</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/recovery.c?id=900241a5cc15e6e0709a012051cc72d224cd6a6e#n469"><code>fs/bcachefs/recovery.c</code></a><span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">journal_replay_entry_early</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span>
				      <span class="z-storage z-type z-c">struct</span> jset_entry <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">entry</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
	<span class="z-storage z-type z-c">int</span> ret <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>

	<span class="z-keyword z-control z-c">switch</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>entry<span class="z-punctuation z-accessor z-c">-&gt;</span>type<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
	<span class="z-keyword z-control z-c">case</span> BCH_JSET_ENTRY_btree_root<span class="z-punctuation z-separator z-c">:</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>

		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">unlikely</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-keyword z-operator z-arithmetic z-c">!</span>entry<span class="z-punctuation z-accessor z-c">-&gt;</span>u64s</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
			<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>

<mark>		<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">fsck_err_on</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">entry<span class="z-punctuation z-accessor z-c">-&gt;</span>btree_id <span class="z-keyword z-operator z-comparison z-c">&gt;=</span> BTREE_ID_NR_MAX<span class="z-punctuation z-separator z-c">,</span>
</mark><mark>				c<span class="z-punctuation z-separator z-c">,</span> invalid_btree_id<span class="z-punctuation z-separator z-c">,</span>
</mark><mark>				<span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&quot;</span>invalid btree id <span class="z-constant z-other z-placeholder z-c">%u</span> (max <span class="z-constant z-other z-placeholder z-c">%u</span>)<span class="z-punctuation z-definition z-string z-end z-c">&quot;</span></span><span class="z-punctuation z-separator z-c">,</span>
</mark><mark>				entry<span class="z-punctuation z-accessor z-c">-&gt;</span>btree_id<span class="z-punctuation z-separator z-c">,</span> BTREE_ID_NR_MAX</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span>
</mark>			<span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>

		…
<span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span></span></code></pre>
<p>Examining the functions in the call trace will show that this function is indeed called before the failure point.</p>
<p>This seems familiar to the previous case, doesn’t it? There’s a validation check in place, but it doesn’t actually stop the code from proceeding, for whatever reason. Let’s find out.</p>
<p>This check was introduced in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=9e7cfb35e2668e542c333ed3ec4b0a951dd332ee"><code>9e7cfb35e266</code></a>. A later commit, <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=14152654805256d760315ec24e414363bfa19a06"><code>141526548052</code></a>, introduced this bug. It is worthwhile to see what exactly these two commits do.</p>
<p>The first introduces a new error type called <code>invalid_btree_id</code> in <code>sb-errors_format.h</code>.<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><code>sb</code> stands for superblock.<span class="sidenote-surroundings">)&nbsp;</span></small> The second marks the error types <code>btree_root_bkey_invalid</code> and <code>btree_root_read_error</code> as <code>FSCK_AUTOFIX</code>. Why did that make the bug happen? Look at these lines from the crash report, just before <abbr>UBSAN</abbr> blows up:</p>
<pre class="z-code"><code><span class="z-text z-plain">  node offset 0/16 bset u64s 0: incorrect max key U64_MAX:18374686479671623680:50331647, btree topology error: 
bcachefs (loop0): flagging btree xattrs lost data
bcachefs (loop0): running explicit recovery pass check_backpointers_to_extents (16), currently at recovery_pass_empty (0)
bcachefs (loop0): running explicit recovery pass scan_for_btree_nodes (1), currently at recovery_pass_empty (0)
<mark>bcachefs (loop0): error reading btree root btree=xattrs level=0: btree_node_read_error, fixing
</mark></span></code></pre>
<p>It looks as if marking <code>btree_root_read_error</code> as autofix caused us to attempt to fix it (as expected), and that codepath ran into this issue.</p>
<p>Back to why the validation check didn’t work. Once again, let’s look at how <code>fsck_err_on</code> actually works. Long story short, it expands into a bunch of macros:</p>
<small class="sidenote marginnote">&#8203;<span class="sidenote-surroundings">&nbsp;(</span><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/bcachefs/error.h?id=900241a5cc15e6e0709a012051cc72d224cd6a6e#n90"><code>fs/bcachefs/error.h</code></a></p>
<p>Note that in the call we’re looking at, <code>_err_type</code> is <code>invalid_btree_id</code>, and <code>_flags</code> is <code>FSCK_CAN_FIX|FSCK_CAN_IGNORE</code>.<span class="sidenote-surroundings">)&nbsp;</span></small><pre data-lang="c" class="language-c z-code"><code class="language-c" data-lang="c"><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">bch2_fsck_err</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">_flags</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">_err_type</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c">				<span class="z-punctuation z-separator z-continuation z-c">\</span>
	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__bch2_fsck_err</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">type_is</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-ternary z-c">?</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">struct</span> bch_fs <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> c <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c">,</span>\
			<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">type_is</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">c<span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">struct</span> btree_trans <span class="z-keyword z-operator z-c">*</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-ternary z-c">?</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-storage z-type z-c">struct</span> btree_trans <span class="z-keyword z-operator z-c">*</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> c <span class="z-keyword z-operator z-ternary z-c">:</span> <span class="z-constant z-language z-c">NULL</span><span class="z-punctuation z-separator z-c">,</span>\
			_flags<span class="z-punctuation z-separator z-c">,</span> BCH_FSCK_ERR_##_err_type<span class="z-punctuation z-separator z-c">,</span> __VA_ARGS__</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span>

<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">fsck_err_wrap</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">_do</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c">						<span class="z-punctuation z-separator z-continuation z-c">\</span>
<span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>									\
	<span class="z-storage z-type z-c">int</span> _ret <span class="z-keyword z-operator z-assignment z-c">=</span> _do<span class="z-punctuation z-terminator z-c">;</span>							\
	<span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>_ret <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>BCH_ERR_fsck_fix <span class="z-keyword z-operator z-arithmetic z-c">&amp;&amp;</span>				\
	    _ret <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>BCH_ERR_fsck_ignore<span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>				\
		ret <span class="z-keyword z-operator z-assignment z-c">=</span> _ret<span class="z-punctuation z-terminator z-c">;</span>						\
		<span class="z-keyword z-control z-flow z-goto z-c">goto</span> fsck_err<span class="z-punctuation z-terminator z-c">;</span>						\
	<span class="z-punctuation z-section z-block z-end z-c">}</span></span>								\
									\
	_ret <span class="z-keyword z-operator z-comparison z-c">==</span> <span class="z-keyword z-operator z-arithmetic z-c">-</span>BCH_ERR_fsck_fix<span class="z-punctuation z-terminator z-c">;</span>					\
<span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span>

<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">__fsck_err</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c">		<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">fsck_err_wrap</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">bch2_fsck_err</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">__VA_ARGS__</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span>

<span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-function z-preprocessor z-c">fsck_err_on</span></span><span class="z-meta z-preprocessor z-macro z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-variable z-parameter z-c">cond</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">c</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-variable z-parameter z-c">_err_type</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-preprocessor z-macro z-c">				<span class="z-punctuation z-separator z-continuation z-c">\</span>
	<span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">__fsck_err_on</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">cond<span class="z-punctuation z-separator z-c">,</span> c<span class="z-punctuation z-separator z-c">,</span> FSCK_CAN_FIX<span class="z-keyword z-operator z-arithmetic z-c">|</span>FSCK_CAN_IGNORE<span class="z-punctuation z-separator z-c">,</span> _err_type<span class="z-punctuation z-separator z-c">,</span> __VA_ARGS__</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span></span>
</span></code></pre>
<p>We only <code>goto fsck_err</code> if what <code>__bch2_fsck_err</code> returns is neither <code>fsck_fix</code> nor <code>fsck_ignore</code>.</p>
<p>My <a href="https://lore.kernel.org/all/20250627084033.614376-2-bharadwaj.raju777@gmail.com/T/">first patch</a> thus proposed that we use <code>mustfix_fsck_err_on</code> instead of <code>fsck_err_on</code>, which doesn’t pass <code>FSCK_CAN_IGNORE</code> as part of the <code>_flags</code>. However, it was pointed out that we can just mark <code>invalid_btree_id</code> autofix as well, and then <code>__bch2_fsck_err</code> would (auto)fix it. So that’s what my <a href="https://lore.kernel.org/all/20250627164132.25133-1-bharadwaj.raju777@gmail.com/T/">second patch</a> did, and was accepted.</p>
<h3 id="false-positives-from-kmsan"><a class="zola-anchor" href="#false-positives-from-kmsan" aria-label="Anchor link for: false-positives-from-kmsan">False Positives from <abbr>KMSAN</abbr></a></h3>
<p>I spent a lot of time trying and failing to investigate this bug: <a href="https://syzkaller.appspot.com/bug?extid=655143dc5f99972b52e6"><abbr>KMSAN</abbr>: uninit-value in <code>bch2_btree_ptr_v2_validate</code></a>. I did not see how the value in question was possibly uninitialized.</p>
<p>Until shortly after, when this patch series was posted to the linux-bcachefs mailing list which showed that most of the <abbr>KMSAN</abbr> bugs recorded against bcachefs were spurious: <a href="https://lore.kernel.org/linux-bcachefs/20250320213256.3359777-1-kent.overstreet@linux.dev/T/">[PATCH 0/5] kmsan splat fixes</a>.</p>
<p><abbr>KMSAN</abbr> doesn’t understand <code>memcpy</code>s implemented using inline assembly, and it has trouble when a struct’s fields are initialized via stores to bitfields.</p>
<p>I learned that I could stand to take a little more seriously my suspicions of sanitizers when their reports didn’t seem to match up to what I saw. I had it in the back of my mind, but my inexperience made me apprehensive of just dismissing a report from an established tool. All in all, educational despite me not getting a bugfix out of this one.</p>
<h2 id="sensor-driver"><a class="zola-anchor" href="#sensor-driver" aria-label="Anchor link for: sensor-driver">Sensor Driver</a></h2>
<p>I spent the rest of my time developing an <abbr>IIO</abbr> kernel driver for the InvenSense <abbr>ICM</abbr>-20948 sensor, which combines an accelerometer, gyrometer, and magnetometer. This post is long enough as it is, so I’ll talk about that another time. Maybe when it’s actually merged.</p>
<h2 id="reflections"><a class="zola-anchor" href="#reflections" aria-label="Anchor link for: reflections">Reflections</a></h2>
<p>I split my time during this program between bugfixes and driver development. I semi-intentionally eschewed those  contribution opportunities which were in the shape of “find and update uses of this old <abbr>API</abbr> to the new one” firstly because I did not find them that interesting to work on, and also because as I observed with my peers, <span class="sidenote-ref"><span class="sidenote-ref-text">a lot of such patches were seen as churn and rejected by maintainers</span><span class="sidenote-number"><small class="sidenote" role="note"><!--&#8203;-->&nbsp;<span class="sidenote-surroundings">&nbsp;(</span>For a particularly incisive example, see <a href="https://lore.kernel.org/all/aHg7JOY5UrOck9ck@dread.disaster.area/">Re: [PATCH] xfs: replace strncpy with strscpy</a>.<span class="sidenote-surroundings">)&nbsp;</span></small></span></span>
.</p>
<p>Being in the <abbr>LKMP</abbr> was as rewarding as it was challenging. If you’re interested in becoming a kernel developer, I recommend it wholeheartedly. The program structure is extremely flexible, so you can do it alongside other obligations. Contributing to the Linux kernel can be rather daunting and even discouraging, so having a mentor to guide you through the initial troubles is really valuable.</p>
<p>Finally… thank you to Shuah Khan, Ricardo B. Marlière, and Javier Carrasco!</p>

  <div class="tombstone"></div>
</main>

<script src="/js/scrollsync.js"></script>

    </div>
  </section>
</body>

</html>
